<?php

namespace App\Filament\Resources;

use App\Filament\Resources\FacturaDisenoResource\Pages;
use App\Models\FacturaDiseno;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;

class FacturaDisenoResource extends Resource
{
    protected static ?string $model = FacturaDiseno::class;

    protected static ?string $navigationIcon = 'heroicon-o-paint-brush';
    
    protected static ?string $navigationLabel = 'Diseños de Facturas';
    
    protected static ?string $navigationGroup = 'Configuración';

    protected static ?string $label = 'Diseño de Factura';
    
    protected static ?string $pluralLabel = 'Diseños de Facturas';

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                // Vista Previa en Tiempo Real
                Forms\Components\Section::make('Vista Previa')
                    ->schema([
                        Forms\Components\ViewField::make('vista_previa')
                            ->label('')
                            ->view('components.factura-preview-livewire')
                            ->reactive()
                            ->columnSpanFull(),
                    ])
                    ->collapsible()
                    ->collapsed(false),

                Forms\Components\Section::make('Información Básica')
                    ->schema([
                        Forms\Components\TextInput::make('nombre')
                            ->required()
                            ->maxLength(255)
                            ->unique(ignoreRecord: true),
                        
                        Forms\Components\Textarea::make('descripcion')
                            ->maxLength(500),
                        
                        Forms\Components\Grid::make(2)
                            ->schema([
                                Forms\Components\Toggle::make('activo')
                                    ->default(true),
                                
                                Forms\Components\Toggle::make('es_predeterminado')
                                    ->label('Diseño Predeterminado'),
                            ]),
                    ]),

                Forms\Components\Section::make('Configuración de Página')
                    ->schema([
                        Forms\Components\Grid::make(3)
                            ->schema([
                                Forms\Components\Select::make('template_archivo')
                                    ->label('Plantilla')
                                    ->options([
                                        'factura_basica' => 'Básica',
                                        'factura_moderna' => 'Moderna',
                                        'factura_clinica' => 'Clínica',
                                        'factura_elegante' => 'Elegante',
                                    ])
                                    ->default('factura_basica'),
                                
                                Forms\Components\Select::make('orientacion_papel')
                                    ->label('Orientación')
                                    ->options([
                                        'portrait' => 'Vertical',
                                        'landscape' => 'Horizontal',
                                    ])
                                    ->default('portrait'),
                                
                                Forms\Components\Select::make('tamaño_papel')
                                    ->label('Tamaño de Papel')
                                    ->options([
                                        'A4' => 'A4',
                                        'Letter' => 'Carta',
                                        'Legal' => 'Legal',
                                    ])
                                    ->default('A4'),
                            ]),
                    ]),

                Forms\Components\Section::make('Colores del Diseño')
                    ->schema([
                        Forms\Components\Grid::make(4)
                            ->schema([
                                Forms\Components\ColorPicker::make('color_primario')
                                    ->label('Color Principal'),
                                
                                Forms\Components\ColorPicker::make('color_secundario')
                                    ->label('Color Secundario'),
                                
                                Forms\Components\ColorPicker::make('color_acento')
                                    ->label('Color de Acento'),
                                
                                Forms\Components\ColorPicker::make('color_texto')
                                    ->label('Color del Texto'),
                            ]),
                    ])
                    ->collapsible(),

                Forms\Components\Section::make('Tipografía')
                    ->schema([
                        Forms\Components\Grid::make(2)
                            ->schema([
                                Forms\Components\Select::make('fuente_titulo')
                                    ->label('Fuente para Títulos')
                                    ->options([
                                        'Arial Black' => 'Arial Black',
                                        'Times New Roman' => 'Times New Roman',
                                        'Helvetica' => 'Helvetica',
                                        'Georgia' => 'Georgia',
                                    ])
                                    ->default('Arial Black'),
                                
                                Forms\Components\Select::make('fuente_texto')
                                    ->label('Fuente para Texto')
                                    ->options([
                                        'Arial' => 'Arial',
                                        'Times New Roman' => 'Times New Roman',
                                        'Helvetica' => 'Helvetica',
                                        'Georgia' => 'Georgia',
                                    ])
                                    ->default('Arial'),
                            ]),
                        
                        Forms\Components\Grid::make(3)
                            ->schema([
                                Forms\Components\TextInput::make('tamaño_titulo')
                                    ->label('Tamaño Título')
                                    ->numeric()
                                    ->default(18)
                                    ->suffix('px'),
                                
                                Forms\Components\TextInput::make('tamaño_subtitulo')
                                    ->label('Tamaño Subtítulo')
                                    ->numeric()
                                    ->default(14)
                                    ->suffix('px'),
                                
                                Forms\Components\TextInput::make('tamaño_texto')
                                    ->label('Tamaño Texto')
                                    ->numeric()
                                    ->default(12)
                                    ->suffix('px'),
                            ]),
                    ])
                    ->collapsible(),

                Forms\Components\Section::make('Elementos Visuales')
                    ->schema([
                        Forms\Components\Fieldset::make('Logo')
                            ->schema([
                                Forms\Components\Toggle::make('mostrar_logo')
                                    ->label('Mostrar Logo'),
                                
                                Forms\Components\Select::make('posicion_logo')
                                    ->label('Posición del Logo')
                                    ->options([
                                        'izquierda' => 'Izquierda',
                                        'centro' => 'Centro',
                                        'derecha' => 'Derecha',
                                    ])
                                    ->default('izquierda'),
                                
                                Forms\Components\Grid::make(2)
                                    ->schema([
                                        Forms\Components\TextInput::make('tamaño_logo_ancho')
                                            ->label('Ancho Logo')
                                            ->numeric()
                                            ->default(120)
                                            ->suffix('px'),
                                        
                                        Forms\Components\TextInput::make('tamaño_logo_alto')
                                            ->label('Alto Logo')
                                            ->numeric()
                                            ->default(80)
                                            ->suffix('px'),
                                    ]),
                            ]),

                        Forms\Components\Fieldset::make('Encabezado')
                            ->schema([
                                Forms\Components\Toggle::make('mostrar_titulo_factura')
                                    ->label('Mostrar Título "FACTURA"'),
                                
                                Forms\Components\TextInput::make('texto_titulo_factura')
                                    ->label('Texto del Título')
                                    ->default('FACTURA'),
                                
                                Forms\Components\Grid::make(3)
                                    ->schema([
                                        Forms\Components\Toggle::make('mostrar_numero_factura')
                                            ->label('Mostrar Número'),
                                        
                                        Forms\Components\Toggle::make('mostrar_fecha_emision')
                                            ->label('Mostrar Fecha Emisión'),
                                        
                                        Forms\Components\Toggle::make('mostrar_fecha_vencimiento')
                                            ->label('Mostrar Fecha Vencimiento'),
                                    ]),
                            ]),
                    ])
                    ->collapsible(),

                Forms\Components\Section::make('Información CAI')
                    ->schema([
                        Forms\Components\Grid::make(2)
                            ->schema([
                                Forms\Components\Toggle::make('mostrar_cai')
                                    ->label('Mostrar CAI'),
                                
                                Forms\Components\Select::make('posicion_cai')
                                    ->label('Posición CAI')
                                    ->options([
                                        'superior' => 'Superior',
                                        'inferior' => 'Inferior',
                                        'lateral' => 'Lateral',
                                    ])
                                    ->default('superior'),
                            ]),
                        
                        Forms\Components\Grid::make(2)
                            ->schema([
                                Forms\Components\Toggle::make('mostrar_rango_cai')
                                    ->label('Mostrar Rango CAI'),
                                
                                Forms\Components\Toggle::make('mostrar_fecha_limite_cai')
                                    ->label('Mostrar Fecha Límite'),
                            ]),
                    ])
                    ->collapsible(),

                Forms\Components\Section::make('Pie de Página')
                    ->schema([
                        Forms\Components\Toggle::make('mostrar_pie_pagina')
                            ->label('Mostrar Pie de Página'),
                        
                        Forms\Components\Textarea::make('texto_pie_pagina')
                            ->label('Texto del Pie de Página')
                            ->rows(3),
                        
                        Forms\Components\Grid::make(3)
                            ->schema([
                                Forms\Components\Toggle::make('mostrar_firma_medico')
                                    ->label('Mostrar Firma Médico'),
                                
                                Forms\Components\Toggle::make('mostrar_sello_centro')
                                    ->label('Mostrar Sello Centro'),
                                
                                Forms\Components\Toggle::make('mostrar_qr_pago')
                                    ->label('Mostrar QR de Pago'),
                            ]),
                    ])
                    ->collapsible(),

                Forms\Components\Section::make('CSS Personalizado')
                    ->schema([
                        Forms\Components\Textarea::make('css_personalizado')
                            ->label('CSS Adicional')
                            ->rows(10)
                            ->placeholder('/* Agrega tu CSS personalizado aquí */'),
                    ])
                    ->collapsible()
                    ->collapsed(),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('nombre')
                    ->searchable()
                    ->sortable(),
                
                Tables\Columns\TextColumn::make('template_archivo')
                    ->label('Plantilla')
                    ->badge(),
                
                Tables\Columns\IconColumn::make('es_predeterminado')
                    ->label('Predeterminado')
                    ->boolean(),
                
                Tables\Columns\IconColumn::make('activo')
                    ->boolean(),
                
                Tables\Columns\TextColumn::make('centro.nombre')
                    ->label('Centro Médico')
                    ->searchable(),
                
                Tables\Columns\TextColumn::make('created_at')
                    ->label('Creado')
                    ->dateTime()
                    ->sortable(),
            ])
            ->filters([
                Tables\Filters\TernaryFilter::make('activo'),
                Tables\Filters\TernaryFilter::make('es_predeterminado')
                    ->label('Predeterminado'),
            ])
            ->actions([
                Tables\Actions\ViewAction::make(),
                Tables\Actions\EditAction::make(),
                Tables\Actions\Action::make('establecer_predeterminado')
                    ->label('Hacer Predeterminado')
                    ->icon('heroicon-o-star')
                    ->color('warning')
                    ->action(function (FacturaDiseno $record) {
                        $record->establecerComoPredeterminado();
                    })
                    ->visible(fn (FacturaDiseno $record) => !$record->es_predeterminado),
            ])
            ->bulkActions([
                Tables\Actions\BulkActionGroup::make([
                    Tables\Actions\DeleteBulkAction::make(),
                ]),
            ]);
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListFacturaDisenos::route('/'),
            'create' => Pages\CreateFacturaDiseno::route('/create'),
            'view' => Pages\ViewFacturaDiseno::route('/{record}'),
            'edit' => Pages\EditFacturaDiseno::route('/{record}/edit'),
        ];
    }
}
